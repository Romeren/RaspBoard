<div class="top"></div>
<div class="buttom right"></div>
<style type="text/css">

#slideshow div {
    position:absolute;
    left:0;
    top: 0%;
    background-position: center;
    background-repeat: no-repeat;
    background-size: contain;
}

#slideshow div.top{
    max-width: 100%;
    max-height: 100%;
    width: 100%;
    height: 100%;
    z-index: 1;
    opacity: 1;
    -webkit-transition: all 3s ease-in-out;
}

#slideshow div.out {
    -webkit-transition: all 3s ease-in-out;
}

#slideshow div.buttom {
    z-index: 0;
    opacity: 1;
    width: 0px;
    height: 0px;
    top: 50%;
}

#slideshow div.left {
    left: -5%;
}
#slideshow div.right {
    left: 100%;
}

#slideshow div.up {
    left: 50%;
    top: -100%;
}

#slideshow div.down {
    left: 50%;
    top: 105%;
}


</style>
<script>
var current_image = Math.floor(Math.random() * 1000);
var slideshow_controller = null;
var rotation_interval = null;
var wait_time = 60000;

class slider_controller {
    constructor(start_image, max_buffer_length, loadTime, transitionTime) {
        this.index = start_image;
        this.max_buffer_length = max_buffer_length;

        this.loadTime = loadTime; // time to load image
        this.transitionTime = transitionTime; // time to make image transition

        this.previous = [];
        this.next = [];
        this.current = "";

        this.init_fill_buffer();
    }

    init_fill_buffer(){
        this.get_image_url(this.index, (e)=>{this.current = e;});
        for(var i = 0; i < this.max_buffer_length; i++){
            this.get_image_url(this.index - (i+1), (e)=>{this.previous.push(e);});
            this.get_image_url(this.index + (i+1), (e)=>{this.next.push(e);});
        }
    }

    get_image_url(image_id, callback){
        $.ajax({
            type: 'GET',
            url: '{{ context.references.random_image[0].address }}?image_id=' + image_id ,
            success: function(res){
                callback(res);
            },
            error: function(err){
                console.log(err);
                callback(null);
            }
        });
    }

    next_image(){
        // STEP FORWARD:
        this.index += 1;
        this.previous.splice(0,0, this.current);
        this.previous.pop();
        this.current = this.next.shift();

        // change picture:
        this.change_image(this.current, 'right', 'left');

        // load new image into buffer:
        var load_index = this.index + (this.max_buffer_length -1);
        this.get_image_url(load_index, (e)=>{this.next.push(e);});
    }

    previous_image(){
        // STEP BACK:
        this.index -= 1;
        this.next.splice(0,0, this.current);
        this.next.pop();
        this.current = this.previous.shift();

        // change picture:
        this.change_image(this.current, 'left', 'right');

        // load new image into buffer:
        var load_index = this.index - (this.max_buffer_length -1);
        this.get_image_url(load_index, (e)=>{this.previous.push(e);});

    }

    change_image(url, fromDir, toDir){
        var btm = $('#slideshow .buttom');
        btm.attr('class', 'buttom ' + fromDir);
        btm.css('background-image', 'url("' + url + '")');
        setTimeout(()=>{
            var buttom = $('#slideshow .buttom');
            var top = $('#slideshow .top');
            buttom.attr('class', 'top');
            top.attr('class', 'buttom out '+ toDir);
            setTimeout(()=>{
                var btm = $('#slideshow .buttom');
                btm.css("background-image",'None');
                btm.attr('class', 'buttom');
            },this.transitionTime);
        },this.loadTime);
    }
}

$(function(){
    slideshow_controller = new slider_controller(0,3,4000, 3000);

    slideshow_controller.next_image();
    rotation_interval = setInterval(function(){
        slideshow_controller.next_image();
    }, wait_time);

    document.addEventListener('KEY_FASTFORWARD',function(){
        // $('#test').text('KEY_FASTFORWARD');
        if(rotation_interval != null){
            clearInterval(rotation_interval);
            rotation_interval = null;
        }
        slideshow_controller.next_image();
    });
    document.addEventListener('KEY_REWIND',function(){
        // $('#test').text('KEY_REWIND');
        if(rotation_interval != null){
            clearInterval(rotation_interval);
            rotation_interval = null;
        }
        slideshow_controller.previous_image();
    });
    document.addEventListener('KEY_PLAY', function(){
        if(rotation_interval == null){
            slideshow_controller.next_image();
            rotation_interval = setInterval(function(){
                slideshow_controller.next_image();
            }, wait_time);
        }
    });
    document.addEventListener('KEY_PAUSE', function(){
        if(rotation_interval != null){
            clearInterval(rotation_interval);
        }
    });
});
</script>
