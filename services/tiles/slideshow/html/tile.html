<div class="top"></div>
<div class="buttom right"></div>
<style type="text/css">

#slideshow div {
    position:absolute;
    left:0;
    top: 0%;
    -webkit-transition: all 4s ease-in-out;
    background-position: center;
    background-repeat: no-repeat;
    background-size: contain;
}

#slideshow div.top{
    max-width: 100%;
    max-height: 100%;
    width: 100%;
    height: 100%;
    z-index: 1;
    opacity: 1;
}

#slideshow div.buttom {
    z-index: 0;
    opacity: 1;
    width: 0px;
    height: 0px;
    top: 50%;
}

#slideshow div.left {
    left: -5%;
}
#slideshow div.right {
    left: 100%;
}

#slideshow div.up {
    left: 50%;
    top: -100%;
}

#slideshow div.down {
    left: 50%;
    top: 105%;
}


</style>
<script>
var waitTime = 120000;
var transitionTime = 4000;
var loadTime = 1500;
var slideshow_command = null;
var waitTime_timeOut = null;
function get_image_url(callback){
    $.ajax({
        type: 'GET',
        url: '{{ context.references.random_image[0].address }}',
        success: function(res){
            callback(res);
        },
        error: function(err){
            console.log(err);
            callback(null);
        }
    });
}

function set_image(url, callback){
    var btm = $('#slideshow .buttom');
    // btm[0].src = url;
    btm.css('background-image', 'url("' + url + '")');
    transition(callback);
}

function transition(callback){
    setTimeout(function(){
        var buttom = $('#slideshow .buttom');
        var top = $('#slideshow .top');
        buttom.attr('class', 'top');
        top.attr('class', 'buttom left');
        setTimeout(function(){
            var btm = $('#slideshow .buttom');
            // btm[0].src = "";
            btm.css("background-image",'None');
            btm.attr('class', 'buttom right');
            if(slideshow_command != null){
                callback();
            }else{
                waitTime_timeOut = setTimeout(function(){
                    waitTime_timeOut = null;
                    callback()
                }, waitTime);
            }
        }, transitionTime); // transition time
    },loadTime); // load image time
}

function slideshow_recursion(){
    get_image_url(function(url){
        if(url != null){
            set_image(url, function(){
                if(slideshow_command != null){
                    slideshow_command = null;
                }
                slideshow_recursion();
            });
        }else{
            setTimeout(slideshow_recursion(),3000);
        }
    });
}

$(function(){
    slideshow_recursion();

    document.addEventListener('KEY_FASTFORWARD',function(){
        // $('#test').text('KEY_FASTFORWARD');
        slideshow_command = {'cmd': 'next' };
        if(waitTime_timeOut != null){
            clearTimeout(waitTime_timeOut);
            slideshow_recursion();
        }
    });
    document.addEventListener('KEY_REWIND',function(){
        // $('#test').text('KEY_REWIND');
        slideshow_command = {'cmd': 'previous' };
        if(waitTime_timeOut != null){
            clearTimeout(waitTime_timeOut);
            slideshow_recursion();
        }
    });
});
</script>
